////
// To add a release, copy and paste the following text,  uncomment the relevant
// sections, and add a link to the new section in the list of releases at the
// top of the page. Note that release subheads must be floated and sections
// cannot be empty.
// TEMPLATE

// [[release-notes-n.n.n]]
// == {es} version n.n.n

//[float]
[[breaking-n.n.n]]
//=== Breaking Changes

//[float]
//=== Breaking Java Changes

//[float]
//=== Deprecations

//[float]
//=== New Features

//[float]
//=== Enhancements

//[float]
//=== Bug Fixes

//[float]
//=== Regressions

//[float]
//=== Known Issues
////

[[release-notes-6.4.3]]
== {es} version 6.4.3

Also see <<breaking-changes-6.4>>.

[float]
[[enhancement-6.4.3]]
=== Enhancements

Machine learning::
* Changes linker options on macOS to allow Homebrew installs ({ml-pull}225[#225])

[[bug-6.4.3]]
[float]
=== Bug fixes

Aggregations::
* Check self references in metric agg after last doc collection (#33593) {es-pull}34001[#34001]

Authentication::
* ListenableFuture should preserve ThreadContext (CVE-2018-17244) {es-pull}34394[#34394]
* Allow an AuthenticationResult to return metadata {es-pull}34382[#34382] (issues: {es-issue}34290[#34290], {es-issue}34332[#34332])
* Preserve thread context during authentication  {es-pull}34290[#34290]

Circuit Breakers::
* Make accounting circuit breaker settings dynamic {es-pull}34372[#34372] (issue: {es-issue}34368[#34368])

Java High Level REST Client::
* HLRC: Fixing bug when getting a missing pipeline {es-pull}34286[#34286] (issue: {es-issue}34119[#34119])

Machine learning::
* Fixes the cause of `hard_limit` memory errors for jobs with bucket spans greater 
than one day ({ml-pull}243[#243])
* Rules that trigger the `skip_model_update` action should also apply to the 
anomaly model. This fixes an issue where anomaly scores of results that triggered 
the rule would decrease if they occurred frequently. {ml-pull}222[#222] (issue: {ml-issue}217[#217])

Network::
*  Support PKCS#11 tokens as keystores and truststores  {es-pull}34063[#34063] (issue: {es-issue}11[#11])
* Correctly handle PKCS#11 tokens for system keystore {es-pull}33460[#33460] (issues: {es-issue}11[#11], {es-issue}33459[#33459])

Security::
* Security: use x-pack config files when present {es-pull}33688[#33688] (issue: {es-issue}33464[#33464])

[[release-notes-6.4.2]]
== {es} version 6.4.2

[[enhancement-6.4.2]]
[float]
=== Enhancements

Search::
* Add a limit for graph phrase query expansion {es-pull}34031[#34031]

[[bug-6.4.2]]
[float]
=== Bug fixes

Core::
* Fix AutoQueueAdjustingExecutorBuilder settings validation {es-pull}33922[#33922]

Index APIs::
* Allow to clear the fielddata cache per field {es-pull}33807[#33807] (issue: {es-issue}33798[#33798])

Network::
*  Support PKCS#11 tokens as keystores and truststores  [OPEN] {es-pull}34063[#34063] (issue: {es-issue}11[#11])
* Correctly handle PKCS#11 tokens for system keystore {es-pull}33460[#33460] (issues: {es-issue}11[#11], {es-issue}33459[#33459])

Security::
* Security: use default scroll keepalive {es-pull}33639[#33639]

Snapshot/Restore::
* Do not override named S3 client credentials {es-pull}33793[#33793] (issue: {es-issue}33769[#33769])

Watcher::
* Watcher: Ensure triggered watch deletion is sync {es-pull}33799[#33799]

[[release-notes-6.4.1]]
== {es} version 6.4.1

[float]
=== Bug Fixes

Rollover::
{es} can once again start if any shards on the node have been
<<indices-rollover-index, rolled over>>. {es-pull}33394[#33394]

[[release-notes-6.4.0]]
== {es} version 6.4.0

[float]
=== Known issues

{es} 6.4.0 fails to start when PEM encoded private key files that have been exported from `PKCS#12`
keystores are in use. These files can be identified by the existence of lines that start with either
`Bag Attributes` or `Key Attributes` in the beginning of the key file.

These keys can be converted to a supported format using one of the following methods:

* Remove the extra lines from the beginning of the file so that the file starts with the line that starts
  with `-----BEGIN`
* Use openssl to convert it, i.e: `openssl pkcs8 -in old_format.key -topk8 -nocrypt -out new_format.key`
  assuming the key was not password protected.

Also see <<breaking-changes-6.4>>.

[float]
[[breaking-6.4.0]]
=== Breaking Changes

Plugins::
* Plugins: Remove meta plugins {es-pull}30670[#30670]

Search::
* Reject regex search if regex string is too long (#28344) {es-pull}28542[#28542] (issue: {es-issue}28344[#28344])

Task Management::
* Remove metadata customs that can break serialization {es-pull}30945[#30945] (issues: {es-issue}30731[#30731])

[float]
[[breaking-java-6.4.0]]
=== Breaking Java changes

Authentication::
* Configurable password hashing algorithm/cost {es-pull}31234[#31234], {es-pull}32092[#32092] (issue: {es-issue}31723[#31723])

Discovery-Plugins::
* Allow multiple unicast host providers {es-pull}31509[#31509]

Java High Level REST Client::
* Add x-pack-info API {es-pull}31870[#31870]

Java Low Level REST Client::
* Support host selection {es-pull}30523[#30523] (issue: {es-issue}21888[#21888])

[float]
[[deprecation-6.4.0]]
=== Deprecations

Analysis::
* Correct spelling of AnalysisPlugin#requriesAnalysisSettings {es-pull}32025[#32025]
* Deprecate `nGram` and `edgeNGram` names for ngram filters {es-pull}30209[#30209]

Index APIs::
* Add deprecation warning for default shards {es-pull}30587[#30587]
* Deprecate not copy settings and explicitly disallow {es-pull}30404[#30404] (issues: {es-issue}28347[#28347])

Java High Level REST Client::
* Add high-level client methods that accept RequestOptions {es-pull}31069[#31069]

Java Low Level REST Client::
* Client: Deprecate many argument performRequest {es-pull}30315[#30315]

Mapping::
* Deprecate unindexed phrases {es-pull}31072[#31072]

Scripting::
* Deprecate accepting malformed requests in stored script API {es-pull}28939[#28939] (issue: {es-issue}27612[#27612])

Search::
* In the field capabilities API, deprecate support for providing fields in the request body. {es-pull}30157[#30157]

Suggesters::
* Deprecates indexing and querying a context completion field without context {es-pull}30712[#30712] (issue: {es-issue}29222[#29222])

[float]
[[feature-6.4.0]]
=== New Features

Aggregations::
* Add WeightedAvg metric aggregation {es-pull}31037[#31037] (issue: {es-issue}15731[#15731])
* Add a MovingFunction pipeline aggregation, deprecate MovingAvg agg {es-pull}29594[#29594]
* Add missing_bucket option in the composite agg {es-pull}29465[#29465] (issue: {es-issue}29380[#29380])

Analysis::
* Expose lucene's RemoveDuplicatesTokenFilter {es-pull}31275[#31275]
* Multiplexing token filter {es-pull}31208[#31208]
* Adds a new analysis plugin called `analysis_nori` that exposes the Lucene Korean
analysis module. ({es-pull}30397[#30397])
* Adding a char_group tokenizer {es-pull}24186[#24186]

Authentication::
* Add Kerberos authentication support {es-pull}32263[#32263] (issue: {es-issue}30243[#30243])

Authorization::
* Introduce Application Privileges with support for Kibana RBAC {es-pull}32309[#32309]

Java High Level REST Client::
* Add analyze API to high-level rest client {es-pull}31577[#31577] (issue: {es-issue}27205[#27205])
* Add support for search templates to the high-level REST client. {es-pull}30473[#30473]
* Rest High Level client: Add List Tasks {es-pull}29546[#29546] (issue: {es-issue}27205[#27205])

Machine learning::
* Detectors now support {ml-docs}/ml-rules.html[custom rules] that enable the
user to improve machine learning results by providing some domain-specific
knowledge in the form of rule. {ml-pull}119[#119], {es-pull}31110[#31110], {es-pull}31294[#31294] (issue: {es-issue}31110[#31110])
* Reverse engineer Grok patterns from categorization results {es-pull}30125[#30125]

Mapping::
* Add support for field aliases. {es-pull}32172[#32172] (issues: {es-issue}23714[#23714], {es-issue}31372[#31372])
* Add an option to split keyword field on whitespace at query time {es-pull}30691[#30691] (issue: {es-issue}30393[#30393])
* The new <<mapping-ignored-field,`_ignored`>> field enables you to know which
fields got ignored at index time because of the <<ignore-malformed,`ignore_malformed`>>
option. ({es-pull}29658[#29658]) (issue: {es-issue}29494[#29494])

Network::
* Introduce client feature tracking {es-pull}31020[#31020] (issue: {es-issue}30731[#30731])

Plugins::
* Reload secure settings for plugins - backport (#31383) {es-pull}31481[#31481] (issue: {es-issue}29135[#29135])

SQL::
* SQL: Support for escape sequences {es-pull}31884[#31884] (issue: {es-issue}31883[#31883])

Scripting::
* Add more contexts to painless execute api {es-pull}30511[#30511]

Search::
* Index phrases {es-pull}30450[#30450]
* Add a `format` option to `docvalue_fields`. {es-pull}29639[#29639] (issue: {es-issue}27740[#27740])

Watcher::
* Make watcher settings reloadable {es-pull}31746[#31746]

[float]
[[enhancement-6.4.0]]
=== Enhancements

Aggregations::
* Fix wrong NaN check in MovingFunctions#stdDev() {es-pull}31888[#31888]
* Mitigate date histogram slowdowns with non-fixed timezones. {es-pull}30534[#30534] (issue: {es-issue}28727[#28727])
* Build global ordinals terms bucket from matching ordinals {es-pull}30166[#30166] (issue: {es-issue}30117[#30117])

Analysis::
 * Add exclusion option to `keep_types` token filter {es-pull}32012[#32012] (issue: {es-issue}29277[#29277])
 * Added lenient flag for synonym token filter {es-pull}31484[#31484] (issue: {es-issue}30968[#30968])
 * Consistent encoder names {es-pull}29492[#29492]

Audit::
 * Add opaque_id to audit logging {es-pull}31878[#31878] (issue: {es-issue}31521[#31521])

Authentication::
 * Support RequestedAuthnContext {es-pull}31238[#31238] (issue: {es-issue}29995[#29995])
 * Make native realm usage stats accurate {es-pull}30824[#30824]
 * Limit user to single concurrent auth per realm {es-pull}30794[#30794] (issue: {es-issue}30355[#30355])
 * SAML: Process only signed data {es-pull}30641[#30641]

CRUD::
 * Support for remote path in reindex api {es-pull}31290[#31290] (issue: {es-issue}22913[#22913])
 * Don't swallow exceptions on replication {es-pull}31179[#31179] (issue: {es-issue}28571[#28571])

Circuit Breakers::
 * Enhance Parent circuit breaker error message {es-pull}32056[#32056]
 * Split CircuitBreaker-related tests {es-pull}31659[#31659]

Core::
 * Change ObjectParser exception {es-pull}31030[#31030] (issue: {es-issue}30605[#30605])

Discovery-Plugins::
 * Add support for AWS session tokens {es-pull}30414[#30414] (issues: {es-issue}16428[#16428])

Distributed::
 * Avoid sending duplicate remote failed shard requests {es-pull}31313[#31313]

Engine::
 * Adjust translog after versionType is removed in 7.0 {es-pull}32020[#32020] (issue: {es-issue}31945[#31945])
 * Enable engine factory to be pluggable {es-pull}31183[#31183]
 * Allow to trim all ops above a certain seq# with a term lower than X {es-pull}30176[#30176] (issue: {es-issue}10708[#10708])
 * Do not add noop from local translog to translog again {es-pull}29637[#29637]

Geo::
 * Add support for ignore_unmapped to geo sort {es-pull}31153[#31153] (issue: {es-issue}28152[#28152])

Highlighting::
 * Bypass highlight query terms extraction on empty fields {es-pull}32090[#32090]

Index APIs::
 * Add Index UUID to `/_stats` Response {es-pull}31871[#31871] (issue: {es-issue}31791[#31791])
 * add support for write index resolution when creating/updating documents {es-pull}31520[#31520]
 * <<copy-source-settings-on-resize,Allow copying source settings on index resize operations>> {es-pull}30255[#30255] (issue: {es-issue}28347[#28347])

Ingest::
 * Extend KV Processor (#31789) {es-pull}32232[#32232] (issue: {es-issue}31786[#31786])
 * Make a few Processors callable by Painless {es-pull}32170[#32170]
 * date_index_name processor template resolution {es-pull}31841[#31841]
 * Introduction of a bytes processor {es-pull}31733[#31733]
 * Extend allowed characters for grok field names {es-pull}31653[#31653], {es-pull}31722[#31722] (issue: {es-issue}21745[#21745])
 * Ingest: Add ignore_missing option to RemoveProc {es-pull}31693[#31693] (issues: {es-issue}23086[#23086])
 * Enable Templated Fieldnames in Rename {es-pull}31690[#31690] (issue: {es-issue}29657[#29657])
 * Add region ISO code to GeoIP Ingest plugin {es-pull}31669[#31669]
 * Extend allowed characters for grok field names {es-pull}31653[#31653] (issue: {es-issue}21745[#21745])
 * Add ingest-attachment support for per document `indexed_chars` limit {es-pull}31352[#31352]

Java High Level REST Client::
 * Add Snapshots Status API to High Level Rest Client {es-pull}32295[#32295], {es-pull}31515[#31515]
 * Add put watch action {es-pull}32026[#32026], {es-pull}32191[#32191] (issue: {es-issue}29827[#29827])
 * Add Get Snapshots High Level REST API {es-pull}31980[#31980]
 * Add X-Pack usage api {es-pull}31975[#31975]
 * Check that client methods match API defined in the REST spec {es-pull}31825[#31825]
 * Clean Up Snapshot Create Rest API {es-pull}31779[#31779]
 * Add cluster get settings API {es-pull}31706[#31706] (issue: {es-issue}27205[#27205])
 * Add get index API {es-pull}31703[#31703] (issues: {es-issue}27205[#27205])
 * Turn GetFieldMappingsResponse to ToXContentObject {es-pull}31544[#31544]
 * Add Get Snapshots High Level REST API {es-pull}31537[#31537] (issue: {es-issue}27205[#27205])
 * Add Snapshots Status API to High Level Rest Client {es-pull}31515[#31515] (issue: {es-issue}27205[#27205])
 * Add get field mappings to High Level REST API Client {es-pull}31423[#31423] (issue: {es-issue}27205[#27205])
 * Add delete snapshot High Level REST API {es-pull}31393[#31393] (issue: {es-issue}27205[#27205])
 * Add explain High Level REST API {es-pull}31387[#31387] (issue: {es-issue}27205[#27205])
 * Add get stored script and delete stored script to high level REST API {es-pull}31355[#31355] (issue: {es-issue}27205[#27205])
 * Add Create Snapshot to High-Level Rest Client {es-pull}31215[#31215]
 * Add get index templates API {es-pull}31161[#31161] (issue: {es-issue}27205[#27205])
 * Add simulate pipeline API {es-pull}31158[#31158] (issue: {es-issue}27205[#27205])
 * Add validate query API {es-pull}31077[#31077] (issue: {es-issue}27205[#27205])
 * Moved pipeline APIs to ingest namespace {es-pull}31027[#31027]
 * List tasks failure to not lose nodeId {es-pull}31001[#31001]
 * Add Verify Repository High Level REST API {es-pull}30934[#30934] (issue: {es-issue}27205[#27205])
 * Move list tasks API under tasks namespace {es-pull}30906[#30906] (issue: {es-issue}29546[#29546])
 * Add get mappings support to high-level rest client {es-pull}30889[#30889] (issue: {es-issue}27205[#27205])
 * Fix `AliasMetaData#fromXContent` parsing {es-pull}30866[#30866] (issue: {es-issue}28799[#28799])
 * Add delete ingest pipeline API {es-pull}30865[#30865] (issues: {es-issue}27205[#27205])
 * Add get ingest pipeline API {es-pull}30847[#30847] (issues: {es-issue}27205[#27205])
 * Add MultiSearchTemplate support to High Level Rest client {es-pull}30836[#30836]
 * Add put ingest pipeline API {es-pull}30793[#30793] (issue: {es-issue}27205[#27205])
 * Add cancel task API {es-pull}30745[#30745] (issue: {es-issue}27205[#27205])
 * Add Delete Repository High Level REST API {es-pull}30666[#30666] (issue: {es-issue}27205[#27205])
 * Add synced flush API {es-pull}30650[#30650] (issues: {es-issue}27205[#27205])
 * Add PUT Repository High Level REST API {es-pull}30501[#30501] (issue: {es-issue}27205[#27205])
 * Allow caller to set per request options {es-pull}30490[#30490]
 * Add put index template api to high level rest client {es-pull}30400[#30400] (issue: {es-issue}27205[#27205])
 * Add GET Repository High Level REST API {es-pull}30362[#30362] (issue: {es-issue}27205[#27205])
 * Add support for field capabilities to the high-level REST client. {es-pull}29664[#29664] (issue: {es-issue}27205[#27205])
 * Add Cluster Health API {es-pull}29331[#29331] (issue: {es-issue}27205[#27205])
 * Add Get Settings API support to java high-level rest client {es-pull}29229[#29229]
 * Add Get Aliases API to the high-level REST client {es-pull}28799[#28799] (issue: {es-issue}27205[#27205])
 * Register ERR metric with NamedXContentRegistry {es-pull}32320[#32320]

Java Low Level REST Client::
 * Node selector per client rather than per request {es-pull}31471[#31471]
 * NodeSelector for node attributes {es-pull}31296[#31296]
 * Replace Request#setHeaders with addHeader {es-pull}30588[#30588]
 * Preserve REST client auth despite 401 response {es-pull}30558[#30558]
 * Add String flavored setEntity {es-pull}30447[#30447]
 * Refactor Sniffer and make it testable {es-pull}29638[#29638] (issues: {es-issue}25701[#25701], {es-issue}27697[#27697])
 * Add Request object flavored methods {es-pull}29623[#29623]

License::
 * Reuse expiration date of trial licenses {es-pull}31033[#31033], {es-pull}30950[#30950] (issue: {es-issue}30882[#30882])

Logging::
 * Add x-opaque-id to search slow logs {es-pull}31539[#31539] (issue: {es-issue}31521[#31521])

Machine learning::
* If a {ml} datafeed is configured to use cross cluster search to retrieve data,
the remote clusters must have {xpack} installed and a valid licence for {ml}.
If the licence requirements are not met, datafeeds using cross cluster search
will not start. {es-pull}31247[#31247]
 * Use default request durability for .ml-state index {es-pull}32233[#32233]
 * Return statistics about forecasts as part of the job stats and usage API {es-pull}31647[#31647] (issue: {es-issue}31395[#31395])
 * Add description to ML filters {es-pull}31330[#31330]
 * Clean left behind model state docs {es-pull}30659[#30659] (issue: {es-issue}30551[#30551])
 * Hide internal job update options from the REST API {es-pull}30537[#30537]
 * Provide tmp storage for forecasting and possibly any {ml} native jobs {es-pull}30399[#30399]
* Improves and uses periodic boundary condition for seasonal component modeling ({ml-pull}84[#84])
* Improves robustness with respect to outliers in detection and initialization of seasonal components ({ml-pull}90[#90] (issue: {ml-issue}87[#87]))
* Improves behavior when there are abrupt changes in the seasonal components present in a time series ({ml-pull}91[#91] (issue: {ml-issue}6[#6]))
* Adds explicit change point detection and modeling ({ml-pull}92[#92])
* Improves partition analysis memory usage ({ml-pull}97[#97])
* Reduces model memory by storing state for periodicity testing in a compressed format ({ml-pull}104[#104], {ml-pull}100[#100])
* Improves the accuracy of model memory control
({ml-pull}125[#125], {ml-issue}122[#122])
* Improves adaption of the modeling of cyclic components to very localized features
({ml-pull}138[#138], {ml-pull}134[#134])
* Reduces the memory consumed by distribution models ({ml-pull}162[#162], {ml-pull}146[#146])
* Forecasting of large machine learning jobs is now supported by temporarily storing
model state on disk ({ml-pull}89[#89])
* Secures the machine learning processes by preventing system calls such as fork
and exec. The Linux implementation uses Seccomp BPF (secure computing with
Berkeley Packet Filters) to intercept system calls and is available in kernels
since 3.5. On Windows, Job Objects prevent new processes being created and macOS
uses the sandbox functionality ({ml-pull}106[#106], {ml-pull}98[#98])
* Fixes a bug that caused underestimation of the memory used by shared pointers.
Also reduces the memory consumed by unnecessary reference counting ({ml-pull}121[#121], {ml-pull}108, {ml-pull}115[#115])
* Reduces model memory by storing the state for testing predictive calendar
features in a compressed format ({ml-pull}137[#137], {ml-pull}127[#127])
* Always combine duplicate samples when updating population models ({ml-pull}74[#74])
* Speeds up trend model component prediction ({ml-pull}73[#73])
* Encodes distribution model weight style by offset in a fixed size weight array
({ml-pull}54[#54])

Mapping::
 * Remove RestGetAllMappingsAction {es-pull}31129[#31129]
 * Add a doc value format to binary fields. {es-pull}30860[#30860] (issue: {es-issue}30831[#30831])

Monitoring::
 * _cluster/state should always return cluster_uuid {es-pull}30143[#30143]

Network::
 * Backport SSL context names ({es-pull}32223[#32223], {es-pull}30953[#30953])
 * Remove client connections from TcpTransport {es-pull}31886[#31886] (issue: {es-issue}31835[#31835])
 * Support multiple system store types {es-pull}31650[#31650]
 * Use remote client in TransportFieldCapsAction {es-pull}30838[#30838]
 * Replace custom reloadable Key/TrustManager {es-pull}30509[#30509]
 * Derive max composite buffers from max content len {es-pull}29448[#29448]

Packaging::
 * Set elasticsearch user to have non-existent homedir {es-pull}29007[#29007] (issue: {es-issue}14453[#14453])

Plugins::
 * Verify signatures on official plugins {es-pull}30800[#30800]

Ranking::
 * Rename ranking evaluation `quality_level` to `metric_score` {es-pull}32168[#32168]
 * Rename ranking evaluation response `unknown_docs` section {es-pull}32166[#32166]
 * Add Expected Reciprocal Rank metric {es-pull}31891[#31891] (issue: {es-issue}29653[#29653])
 * Add details section for dcg ranking metric {es-pull}31177[#31177]
 * Move templated `_rank_eval` tests {es-pull}30679[#30679] (issue: {es-issue}30628[#30628])
 * Forbid expensive query parts in ranking evaluation {es-pull}30151[#30151] (issue: {es-issue}29674[#29674])

Rollup::
 * Rollup now indexes `null` values, meaning a single "unified" job for heterogeneous data is now the recommended pattern. {es-pull}31402[#31402]
 * Rollup Search endpoint now supports the `terms` query. {es-pull}30973[#30973])
 * Allow rollup job creation only if cluster is X-Pack ready. {es-pull}30963[#30963]
 * Rollups no longer allow patterns that match its `rollup_index`, which can lead to strange errors. {es-pull}30491[#30491]
 * A new API allows getting the rollup capabilities of specific rollup indices,
 rather than by the target pattern. {es-pull}30401[#30401]
 * Validation errors thrown while creating a rollup job are now a specialization of the previous `ActionRequestValidationException`, which makes it easier to catch.
 The new exception is `RollupActionRequestValidationException`. {es-pull}30339[#30339]
 * Validate timezone in range queries to ensure they match the selected job when
 searching. {es-pull}30338[#30338]

SQL::
 * Allow LEFT and RIGHT as function names {es-pull}32066[#32066] (issue: {es-issue}32046[#32046])
 * Add support for single parameter text manipulating functions {es-pull}31874[#31874] (issue: {es-issue}31604[#31604])
 * Remove restriction for single column grouping {es-pull}31818[#31818] (issue: {es-issue}31793[#31793])
 * Make a single JDBC driver jar {es-pull}31012[#31012] (issue: {es-issue}29856[#29856])
 * Remove the last remaining server dependencies from JDBC {es-pull}30771[#30771] (issue: {es-issue}29856[#29856])
 * Whitelist SQL utility class for better scripting {es-pull}30681[#30681] (issue: {es-issue}29832[#29832])
 * Improve compatibility with MS query {es-pull}30516[#30516] (issue: {es-issue}30398[#30398])
 * Reduce number of ranges generated for comparisons {es-pull}30267[#30267] (issue: {es-issue}30017[#30017])
 * Teach the CLI to ignore empty commands {es-pull}30265[#30265] (issue: {es-issue}30000[#30000])
 * JDBC driver prepared statement set* methods {es-pull}31494[#31494] (issue: {es-issue}31493[#31493])

Scripting::
 * Handle missing values in painless {es-pull}[#30975], {es-pull}31903[#31903] (issue: {es-issue}29286[#29286])

Search::
 * Force execution of fetch tasks {es-pull}31974[#31974] (issue: {es-issue}29442[#29442])
 * Add second level of field collapsing {es-pull}31808[#31808] (issue: {es-issue}24855[#24855])
 * Remove QueryCachingPolicy#ALWAYS_CACHE {es-pull}31451[#31451]
 * Cross cluster search: don't proxy requests for already connected node {es-pull}31273[#31273]
 * Reject long regex in query_string {es-pull}31136[#31136] (issue: {es-issue}28344[#28344])
 * Cross cluster search: do not use dedicated masters as gateways {es-pull}30926[#30926] (issue: {es-issue}30687[#30687])
 * Added max_expansion param to span_multi {es-pull}30913[#30913] (issue: {es-issue}27432[#27432])
 * Increase the maximum number of filters that may be in the cache. {es-pull}30655[#30655]
 * Improve explanation in rescore {es-pull}30629[#30629] (issue: {es-issue}28725[#28725])

Security::
 * Introduce fips_mode setting and associated checks {es-pull}32326[#32326], {es-pull}32344[#32344]
 * Tribe: Add error with secure settings copied to tribe {es-pull}32298[#32298] (issue: {es-issue}32117[#32117])
 * Only auto-update license signature if all nodes ready {es-pull}30859[#30859] (issues: {es-issue}30731[#30731])
 * Limit the scope of BouncyCastle dependency {es-pull}30358[#30358]
 * Make licensing FIPS-140 compliant {es-pull}30251[#30251]

Settings::
 * Add notion of internal index settings {es-pull}31286[#31286] (issue: {es-issue}29823[#29823])
 * Move RestGetSettingsAction to RestToXContentListener {es-pull}31101[#31101]
 * Harmonize include_defaults tests {es-pull}30700[#30700]
 * Fold RestGetAllSettingsAction in RestGetSettingsAction {es-pull}30561[#30561]

Snapshot/Restore::
 * ECS Task IAM profile credentials ignored in repository-s3 plugin {es-pull}31864[#31864] (issues: {es-issue}26913[#26913])
 * Add write*Blob option to replace existing blob {es-pull}31729[#31729]
 * Fixture for Minio testing {es-pull}31688[#31688]
 * Do not check for object existence when deleting repository index files {es-pull}31680[#31680]
 * Remove extra check for object existence in repository-gcs read object {es-pull}31661[#31661] time an Azure object is accessed or modified {es-pull}31617[#31617]
 * Lazy snapshot repository initialization {es-pull}31606[#31606]
 * Do not check for S3 blob to exist before writing {es-pull}31128[#31128]
 * Remove extra checks from HdfsBlobContainer {es-pull}31126[#31126]
 * Allow date math for naming newly-created snapshots {es-pull}30479[#30479] (issue: {es-issue}7939[#7939] )
 * Use simpler write-once semantics for HDFS repository {es-pull}30439[#30439]
 * User proper write-once semantics for GCS repository {es-pull}30438[#30438]
 * Use stronger write-once semantics for Azure repository {es-pull}30437[#30437]
 * Use simpler write-once semantics for FS repository {es-pull}30435[#30435]
 * Do not fail snapshot when deleting a missing snapshotted file {es-pull}30332[#30332] (issue: {es-issue}28322[#28322])
 * Repository GCS plugin new client library {es-pull}30168[#30168] (issue: {es-issue}29259[#29259])
 * Fail snapshot operations early on repository corruption {es-pull}30140[#30140] (issues: {es-issue}29649[#29649])
 * Index name added to snapshot restore exception {es-pull}29604[#29604] (issue: {es-issue}27601[#27601])
 * Do not load global state when deleting a snapshot {es-pull}29278[#29278] (issue: {es-issue}28934[#28934])
 * Don't load global state when only restoring indices {es-pull}29239[#29239] (issue: {es-issue}28934[#28934])

Stats::
 * Add `_coordinating_only` for nodes resolving in nodes API {es-pull}30313[#30313] (issue: {es-issue}28831[#28831])

Store::
 * Move caching of the size of a directory to `StoreDirectory`. {es-pull}30581[#30581]

Suggesters::
 * Ignore empty completion input {es-pull}30713[#30713] (issue: {es-issue}23121[#23121])

Task Management::
 * Make Persistent Tasks implementations version and feature aware {es-pull}31045[#31045] (issues: {es-issue}30731[#30731])

Transport API::
 * Implemented XContent serialisation for GetIndexResponse {es-pull}31675[#31675]
 * Send client headers from TransportClient {es-pull}30803[#30803]
 * Modify state of VerifyRepositoryResponse for backwards compatibility {es-pull}30762[#30762]

Watcher::
 * Clean up ensureWatchExists use {es-pull}31926[#31926]
 * Store username on watch execution {es-pull}31873[#31873] (issue: {es-issue}31772[#31772])
 * Consolidate setting update registration {es-pull}31762[#31762]
 * Add secure setting for watcher email password {es-pull}31620[#31620]
 * Slack message empty text {es-pull}31596[#31596] (issue: {es-issue}30071[#30071])
 * Move watcher-history version setting to _meta field {es-pull}30832[#30832] (issue: {es-issue}30731[#30731])
 * Only allow x-pack metadata if all nodes are ready {es-pull}30743[#30743] (issues: {es-issue}30731[#30731])
 * Configure HttpClient parallel sent requests {es-pull}30130[#30130]
 * Watcher: Make start/stop cycle more predictable and synchronous {es-pull}30118[#30118]

ZenDiscovery::
 * Preserve response headers on cluster update task {es-pull}31421[#31421] (issues:  {es-issue}31408[#31408])
 * Treat ack timeout more like a publish timeout {es-pull}31303[#31303]
 * Use system context for cluster state update tasks {es-pull}31241[#31241] (issue: {es-issue}30603[#30603])

[float]
[[bug-6.4.0]]
=== Bug Fixes

Aggregations::
* Fix profiling of ordered terms aggs {es-pull}31814[#31814] (issue: {es-issue}22123[#22123])
* Ensure that ip_range aggregations always return bucket keys. {es-pull}30701[#30701] (issue: {es-issue}21045[#21045])
* Fix class cast exception in BucketMetricsPipeline path traversal {es-pull}30632[#30632] (issue: {es-issue}30608[#30608])
* Fix NPE when CumulativeSum agg encounters null value/empty bucket {es-pull}29641[#29641] (issue: {es-issue}27544[#27544])

Allocation::
* A replica can be promoted and started in one cluster state update {es-pull}32042[#32042]
* Ignore numeric shard count if waiting for ALL {es-pull}31265[#31265] (issue: {es-issue}31151[#31151])
* Move allocation awareness attributes to list setting {es-pull}30626[#30626] (issue: {es-issue}30617[#30617])
* Auto-expand replicas when adding or removing nodes {es-pull}30423[#30423] (issue: {es-issue}1873[#1873])
* Auto-expand replicas only after failing nodes {es-pull}30553[#30553]

Analysis::
* Call setReferences() on custom referring tokenfilters in _analyze {es-pull}32157[#32157] (issue: {es-issue}32154[#32154])

Audit::
* Fix audit index template upgrade loop {es-pull}30779[#30779]

Authentication::
* [Kerberos] Add debug log statement for exceptions {es-pull}32663[#32663]
* Remove Kerberos bootstrap checks {es-pull}32451[#32451]
* Fix building AD URL from domain name {es-pull}31849[#31849]
* resolveHasher defaults to NOOP {es-pull}31723[#31723] (issues: {es-issue}31697[#31697])
* Check auth scheme case insensitively {es-pull}31490[#31490] (issue: {es-issue}31486[#31486])
* Fix joining cluster with production license {es-pull}31341[#31341] (issue: {es-issue}31332[#31332])
* Fix token backwards compatibility with pre 6.0.0-beta2 {es-pull}31254[#31254] (issues: {es-issue}31195[#31195])
* Compliant SAML Response destination check {es-pull}31175[#31175]
* Clean up code in file stores {es-pull}30348[#30348]
* Fix TokenMetaData equals and hashcode {es-pull}30347[#30347]

Authorization::
* Fix role query that can match nested documents {es-pull}32705[#32705]
* Make get all application privileges require "*" permission {es-pull}32460[#32460]
* Revert to old way of merging automata {es-pull}32254[#32254]
* [PKI Realm] Invalidate cache on role mappings change {es-pull}31510[#31510]
* Fix dynamic mapping updates with aliases {es-pull}30787[#30787] (issue: {es-issue}30597[#30597])
* Include an empty JSON object in a JSON array when FLS filters out all fields {es-pull}30709[#30709] (issue: {es-issue}30624[#30624])
* Reduce garbage during index resolution {es-pull}30180[#30180]

CRUD::
* Bulk operation fail to replicate operations when a mapping update times out {es-pull}30244[#30244]

Core::
* Fix content type detection with leading whitespace {es-pull}32632[#32632] (issue: {es-issue}32357[#32357])
* Disable C2 from using AVX-512 on JDK 10 {es-pull}32138[#32138] (issue: {es-issue}31425[#31425])
* Create default ES_TMPDIR on Windows {es-pull}30325[#30325]
* Pick inner most parse exception as root cause {es-pull}30270[#30270] (issues: issue}30261[#30261])

Distributed::
* Fix race between replica reset and primary promotion {es-pull}32442[#32442] (issues: {es-issue}32118[#32118], {es-issue}32304[#32304], {es-issue}32431[#32431])
* ClassCastException when re-throwing "shard not available" exception in TransportShardMultiGetAction {es-pull}32185[#32185] (issue: {es-issue}32173[#32173])

Engine::
* Fail shard if IndexShard#storeStats runs into an IOException {es-pull}32241[#32241] (issue: {es-issue}29008[#29008])
* IndexShard should not return null stats {es-pull}31528[#31528]

Geo::
* Fix handling of points_only with term strategy in geo_shape {es-pull}31766[#31766] (issue: {es-issue}31707[#31707])
* Fix coerce validation_method in GeoBoundingBoxQueryBuilder {es-pull}31747[#31747] (issue: {es-issue}31718[#31718])
* Improve robustness of geo shape parser for malformed shapes {es-pull}31449[#31449] (issue: {es-issue}31428[#31428])
* Fix defaults in GeoShapeFieldMapper output {es-pull}31302[#31302] (issue: {es-issue}23206[#23206])
* Add support for indexed shape routing in geo_shape query {es-pull}30760[#30760] (issue: {es-issue}7663[#7663])
* Add validation that geohashes are not empty and don't contain unsupported characters {es-pull}30376[#30376] (issue: {es-issue}23579[#23579])

Index APIs::
* Copy missing segment attributes in getSegmentInfo {es-pull}32396[#32396]
* Add support for is_write_index in put-alias body parsing {es-pull}31674[#31674]
* Fix writeIndex evaluation for aliases {es-pull}31562[#31562]
* Fix IndexTemplateMetaData parsing from xContent {es-pull}30917[#30917]
* Do not ignore request analysis/similarity settings on index resize operations
when the source index already contains such settings. {es-pull}30216[#30216]
* Do not return all indices if a specific alias is requested via get aliases api. {es-pull}29538[#29538] (issues: {es-issue}27763[#27763])

Ingest::
* Fix broken backport of #31578 by adjusting constructor {es-pull}31587[#31587] (issue: {es-issue}31578[#31578])
* Ingest Attachment: Upgrade Tika to 1.18 {es-pull}31252[#31252]
* Interrupt the current thread if evaluation grok expressions take too long {es-pull}31024[#31024] (issue: {es-issue}28731[#28731])

Java High Level REST Client::
* Ban LoggingDeprecationHandler {es-pull}32756[#32756] (issue: {es-issue}32151[#32151])
* Move commercial clients from XPackClient {es-pull}32596[#32596]
* Fix CreateSnapshotRequestTests Failure {es-pull}31630[#31630] (issue: {es-issue}31625[#31625])
* Change bulk's retry condition to be based on RestStatus {es-pull}29329[#29329] (issues: {es-issue}28885[#28885])

Java Low Level REST Client::
* Avoid setting connection request timeout {es-pull}30384[#30384] (issue: {es-issue}24069[#24069])

License::
* Do not serialize basic license expiration in X-Pack info {es-pull}30848[#30848]

Machine learning::
* Move open job failure explanation out of root cause {es-pull}31925[#31925] (issue: {es-issue}29950[#29950])
* Fix calendar and filter updates from non-master nodes {es-pull}31804[#31804] (issue: {es-issue}31803[#31803])
* Don't treat stale FAILED jobs as OPENING in job allocation {es-pull}31800[#31800] (issue: {es-issue}31794[#31794])
* Rate limit established model memory updates {es-pull}31768[#31768]
* Account for gaps in data counts after job is reopened {es-pull}30294[#30294] (issue: {es-issue}30080[#30080])
* Ages seasonal components in proportion to the fraction of values with which they're updated ({ml-pull}88[#88] (issue: {ml-issue}87[#87]))
* Fixes persist and restore, which were missing some of the trend model state.
({ml-pull}103[#103], {ml-pull}99[#99])
* Stops zero variance data from generating a log error in the forecast confidence interval calculation ({ml-pull}120[#120], {ml-pull}107[#107])
* Fixes corner case which was failing to calculate lgamma values and fixes the
corresponding log errors ({ml-pull}131[#131], {ml-pull}126[#126])
* Fixes influence count per bucket for metric population analyses, which was
wrong and lead to incorrect influencer scoring ({ml-pull}153[#153], {ml-pull}150[#150])
* Fixes a possible SIGSEGV for jobs with multivariate by fields enabled, which caused the jobs to fail ({ml-pull}174[#174], {ml-pull}170[#170])
* Corrects the model bounds and typical value calculation for time series models
which use a multimodal distribution. This issue could cause "Unable to bracket
left percentile =..." errors to appear in the logs. ({ml-pull}178[#178], {ml-pull}176[#176])

Mapping::
* Make sure that field collapsing supports field aliases. {es-pull}32648[#32648] (issue: {es-issue}32623[#32623])
* Improve the error message when an index is incompatible with field aliases. {es-pull}32482[#32482]
* Make sure that field aliases count towards the total fields limit. {es-pull}32222[#32222]
* Fix `range` queries on `_type` field for singe type indices (#31756) {es-pull}32161[#32161], {es-pull}31756[#31756] (issues: {es-issue}31476[#31476])
* In NumberFieldType equals and hashCode, make sure that NumberType is taken into account. {es-pull}31514[#31514]
* Get Mapping API to honour allow_no_indices and ignore_unavailable {es-pull}31507[#31507] (issue: {es-issue}31485[#31485])
* Make sure KeywordFieldMapper#clone preserves split_queries_on_whitespace. {es-pull}31049[#31049]
* Delay _uid field data deprecation warning {es-pull}30651[#30651] (issue: {es-issue}30625[#30625])

Monitoring::
* Fix _cluster/state to always return cluster_uuid {es-pull}30656[#30656]

Network::
* Ensure we don't use a remote profile if cluster name matches {es-pull}31331[#31331] (issue: {es-issue}29321[#29321])
* Transport client: Don't validate node in handshake (#30737) {es-pull}31080[#31080] {es-pull}30737[#30737] (issue: {es-issue}30141[#30141])
* Add TRACE, CONNECT, and PATCH http methods {es-pull}31079[#31079], {es-pull}31035[#31035] (issue: {es-issue}31017[#31017])

Packaging::
* Add temporary directory cleanup workarounds {es-pull}32615[#32615] (issue: {es-issue}31732[#31732])
* Add package pre-install check for java binary {es-pull}31343[#31343] (issue: {es-issue}29665[#29665])
* Do not run `sysctl` for `vm.max_map_count` when its already set {es-pull}31285[#31285]
* Stable filemode for zip distributions {es-pull}30854[#30854] (issue: {es-issue}30799[#30799])
* Force stable file modes for built packages {es-pull}30823[#30823] (issue: {es-issue}30799[#30799])

Plugins::
* Template upgrades should happen in a system context {es-pull}30621[#30621] (issue: {es-issue}30603[#30603])

REST API::
* Reject forcemerge requests with a body {es-pull}30792[#30792] (issue: {es-issue}29584[#29584])
* Respect accept header on no handler {es-pull}30383[#30383] (issue: {es-issue}30329[#30329])

Recovery::
* IndicesClusterStateService should replace an init. replica with an init. primary with the same aId {es-pull}32374[#32374] (issue: {es-issue}32308[#32308])
* Ensure to release translog snapshot in primary-replica resync {es-pull}32045[#32045] (issue: {es-issue}32030[#32030])
* Fix missing historyUUID in peer recovery when rolling upgrade 5.x to 6.3 {es-pull}31506[#31506] (issue: {es-issue}31482[#31482])
* Cancelling a peer recovery on the source can leak a primary permit {es-pull}30318[#30318]
* ReplicationTracker.markAllocationIdAsInSync may hang if allocation is cancelled {es-pull}30316[#30316]
* Do not log warn shard not-available exception in replication {es-pull}30205[#30205]

Rollup::
* Move to 128bit document IDs for Rollup.  The old IDs were not wide enough and susceptible to hashing collisions.
Jobs that are running during cluster upgrade will "self-upgrade" to the new ID scheme, but it is recommended that users
fully rebuild Rollup indices from scratch if possible.  Any existing collisions are not fixable and so data-loss may
affect the rollup index despite the new IDs being used. {es-pull}32558[#32558] (issue: {es-issue}32372[#32372])
* Histo group configurations should support `scaled_float` {es-pull}32048[#32048] (issue: {es-issue}32035[#32035])
* Fix rollup on date fields that don't support `epoch_millis` {es-pull}31890[#31890]
* Metric config properly validates itself now {es-pull}31159[#31159]

SQL::
* HAVING clause should accept only aggregates {es-pull}31872[#31872] (issue: {es-issue}31726[#31726])
* Check timeZone argument in AbstractSqlQueryRequest {es-pull}31822[#31822]
* Fix incorrect HAVING equality {es-pull}31820[#31820] (issue: {es-issue}31796[#31796])
* Fix incorrect message for aliases {es-pull}31792[#31792] (issue: {es-issue}31611[#31611])
* Allow long literals {es-pull}31777[#31777] (issue: {es-issue}31750[#31750])
* Fix stackoverflow on getObject and timestamp conversion {es-pull}31735[#31735] (issue: {es-issue}31734[#31734])
* Fix rest endpoint names in node stats {es-pull}31371[#31371]
* Preserve scoring in bool queries {es-pull}30730[#30730] (issue: {es-issue}29685[#29685])
* Verify GROUP BY ordering on grouped columns {es-pull}30585[#30585] (issue: {es-issue}29900[#29900])
* SYS TABLES ordered according to *DBC specs {es-pull}30530[#30530]
* Fix parsing of dates with milliseconds {es-pull}30419[#30419] (issue: {es-issue}30002[#30002])
* Improve correctness of SYS COLUMNS & TYPES {es-pull}30418[#30418] (issue: {es-issue}30386[#30386])
* Fix bug caused by empty composites {es-pull}30343[#30343] (issue: {es-issue}30292[#30292])
* Correct error message {es-pull}30138[#30138] (issue: {es-issue}30016[#30016])
* Add BinaryMathProcessor to named writeables list {es-pull}30127[#30127] (issue: {es-issue}30014[#30014])

Scripting::
* Painless: Fix Bug with Duplicate PainlessClasses {es-pull}32110[#32110]
* Painless: Fix bug for static method calls on interfaces {es-pull}31348[#31348]
* Deprecate Empty Templates {es-pull}30194[#30194]

Search::
* Fix multi level nested sort {es-pull}32204[#32204] (issues: {es-issue}31554[#31554], {es-issue}31783[#31783], {es-issue}32130[#32130])
* Fix race in clear scroll {es-pull}31259[#31259]
* Fix index prefixes to work with span_multi {es-pull}31066[#31066] (issue: {es-issue}31056[#31056])
* Cross Cluster Search: preserve remote status code {es-pull}30976[#30976] (issue: {es-issue}27461[#27461])
* Fix NPE in 'more_like_this' when field has zero tokens {es-pull}30365[#30365] (issue: {es-issue}30148[#30148])
* Fix failure for validate API on a terms query {es-pull}30319[#30319], {es-pull}29483[#29483] (issue: {es-issue}29033[#29033])
* Fix a bug in FieldCapabilitiesRequest#equals and hashCode. {es-pull}30181[#30181]
* Fix TermsSetQueryBuilder.doEquals() method {es-pull}29629[#29629] (issue: {es-issue}29620[#29620])
* Add additional shards routing info in ShardSearchRequest {es-pull}29533[#29533] (issue: {es-issue}27550[#27550])
* Use date format in `date_range` mapping before fallback to default {es-pull}29310[#29310] (issue: {es-issue}29282[#29282])

Security::
* Enable FIPS140LicenseBootstrapCheck {es-pull}32903[#32903]
* Detect old trial licenses and mimic behaviour {es-pull}32209[#32209]
* Preserve thread context when connecting to remote cluster {es-pull}31574[#31574] (issues: {es-issue}31462[#31462])

Snapshot/Restore::
* Fix repository update with the same settings but different type {es-pull}31458[#31458]
* Delete temporary blobs before creating index file {es-pull}30528[#30528] (issues: {es-issue}30507[#30507])

Store::
* Side-step pending deletes check {es-pull}30571[#30571] (issues: {es-issue}30416[#30416], {es-issue}30503[#30503])

Suggesters::
* Add proper longitude validation in geo_polygon_query {es-pull}30497[#30497] (issue: {es-issue}30488[#30488])
* Fix merging logic of Suggester Options {es-pull}29514[#29514]

Transport API::
* Fix interoperability with < 6.3 transport clients {es-pull}30971[#30971] (issue: {es-issue}30731[#30731])
* Fix bad version check writing Repository nodes {es-pull}30846[#30846] (issue: {es-issue}30807[#30807])

Watcher::
* Guard against null in email admin watches {es-pull}32923[#32923] (issue: {es-issue}32590[#32590])
* Fix null failure in watcher test {es-pull}31968[#31968] (issue: {es-issue}31948[#31948])
* Fix chain input toXcontent serialization {es-pull}31721[#31721]
* Add ssl.trust email account setting {es-pull}31684[#31684]
* Fix check for currently executed watches {es-pull}31137[#31137]
* Prevent duplicate watch triggering during upgrade {es-pull}30643[#30643]
* Prevent triggering watch when using activate API {es-pull}30613[#30613]
* Ensure trigger service pauses execution {es-pull}30363[#30363]
* Fix watch history template for dynamic slack attachments {es-pull}30172[#30172]
* Ensure mail message ids are unique per watch action {es-pull}30112[#30112]
* Validate xContentType in PutWatchRequest. {es-pull}31088[#31088] (issue: {es-issue}30057[#30057])

ZenDiscovery::
* Fsync state file before exposing it {es-pull}30929[#30929]
* Use correct cluster state version for node fault detection {es-pull}30810[#30810]
* Only ack cluster state updates successfully applied on all nodes {es-pull}30672[#30672]

[float]
[[regression-6.4.0]]
=== Regressions

Engine::
* Give the engine the whole index buffer size on init. {es-pull}31105[#31105]

Snapshot/Restore::
* S3 repo plugin populate SettingsFilter {es-pull}30652[#30652]

//[float]
//=== Known Issues

[[upgrade-6.4.0]]
[float]
=== Upgrades

Core::
* Dependencies: Upgrade to joda time 2.10 {es-pull}32160[#32160]

Logging::
* LOGGING: Upgrade to Log4J 2.11.1 {es-pull}32616[#32616], {es-pull}32668[#32668] (issues: {es-issue}27300[#27300], {es-issue}32537[#32537])

Network::
* Upgrade to Netty 4.1.25.Final {es-pull}31232[#31232] (issues: {es-issue}31124[#31124], {es-issue}7463[#7463], {es-issue}8014[#8014])
* Revert upgrade to Netty 4.1.25.Final {es-pull}31282[#31282] (issue: {es-issue}31232[#31232])

Search::
* Upgrade to Lucene 7.4.0. {es-pull}31529[#31529]
